{% extends "base.html" %}
{% load static %}

{% block title %}Lista de Usuarios{% endblock %}

{% block breadcrumb %}
<a href="{% url 'usuarios:dashboard' %}">Inicio</a>
<span class="breadcrumb-item active">Usuarios</span>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <strong>Usuarios del Sistema</strong>
          <div class="card-header-actions">
            <a href="{% url 'usuarios:usuario_create' %}" class="btn btn-sm btn-success me-2">
              <i class="bi bi-person-plus"></i> Nuevo Usuario
            </a>
            <a href="{% url 'usuarios:roles_list' %}" class="btn btn-sm btn-info me-2">
              <i class="bi bi-shield-check"></i> Gestionar Roles
            </a>
            {% if show_deleted %}
              <a href="?show_deleted=0" class="btn btn-sm btn-secondary">
                <i class="bi bi-eye-slash"></i> Ocultar eliminados
              </a>
            {% else %}
              <a href="?show_deleted=1" class="btn btn-sm btn-secondary">
                <i class="bi bi-eye"></i> Ver eliminados
              </a>
            {% endif %}
          </div>
        </div>
        <div class="card-body">
          {% if usuarios %}
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Estado</th>
                    <th>Roles</th>
                    <th>Fecha de Registro</th>
                    <th class="text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for usuario in usuarios %}
                    <tr {% if usuario.estado == 'eliminado' %}class="table-danger"{% endif %}>
                      <td><strong>{{ usuario.id }}</strong></td>
                      <td>{{ usuario.email }}</td>
                      <td>
                        {% if usuario.estado == 'eliminado' %}
                          <span class="badge bg-secondary ms-1">Eliminado</span>
                        {% elif usuario.is_active %}
                          <span class="badge bg-success">Activo</span>
                        {% else %}
                          <span class="badge bg-danger">Inactivo</span>
                        {% endif %}<br>
                      </td>
                      <td>
                        {% for role in usuario.get_roles %}
                          <span class="badge bg-primary me-1">{{ role }}</span>
                        {% empty %}
                          <span class="text-muted">Sin roles</span>
                        {% endfor %}
                      </td>
                      <td>{{ usuario.date_joined|date:"d/m/Y H:i" }}</td>
                      <td class="text-center">
                        <div class="btn-group" role="group">
                          <a href="{% url 'usuarios:ver_usuario_roles' usuario.id %}"
                             class="btn btn-sm btn-outline-info"
                             data-bs-toggle="tooltip"
                             title="Ver roles">
                            <i class="bi bi-eye"></i>
                          </a>
                          <a href="{% url 'usuarios:asignar_rol' usuario.id %}"
                             class="btn btn-sm btn-outline-primary"
                             data-bs-toggle="tooltip"
                             title="Asignar roles">
                            <i class="bi bi-shield-check"></i>
                          </a>
                          <a href="{% url 'usuarios:usuario_edit' usuario.id %}"
                             class="btn btn-sm btn-outline-warning"
                             data-bs-toggle="tooltip"
                             title="Editar usuario">
                            <i class="bi bi-pencil"></i>
                          </a>
                          {% if usuario.estado == 'eliminado' %}
                            <a href="{% url 'usuarios:usuario_restore' usuario.id %}"
                               class="btn btn-sm btn-outline-success"
                               data-bs-toggle="tooltip"
                               title="Restaurar usuario">
                              <i class="bi bi-arrow-counterclockwise"></i>
                            </a>
                          {% else %}
                            <a href="{% url 'usuarios:usuario_delete' usuario.id %}"
                               class="btn btn-sm btn-outline-danger"
                               data-bs-toggle="tooltip"
                               title="Eliminar usuario">
                              <i class="bi bi-trash"></i>
                            </a>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- EstadÃ­sticas -->
            <div class="row mt-4">
              <div class="col-md-4">
                <div class="card text-bg-primary">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h5 class="card-title mb-0">Total Usuarios</h5>
                        <h2 class="mb-0" id="total-usuarios">{{ usuarios|length }}</h2>
                      </div>
                      <i class="bi bi-people fs-1 opacity-75"></i>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card text-bg-success">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h5 class="card-title mb-0">Usuarios Activos</h5>
                        <h2 class="mb-0" id="usuarios-activos">0</h2>
                      </div>
                      <i class="bi bi-check-circle fs-1 opacity-75"></i>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card text-bg-warning">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h5 class="card-title mb-0">Usuarios Inactivos</h5>
                        <h2 class="mb-0" id="usuarios-inactivos">0</h2>
                      </div>
                      <i class="bi bi-exclamation-circle fs-1 opacity-75"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              No hay usuarios registrados en el sistema.
              <a href="{% url 'usuarios:registro' %}" class="btn btn-sm btn-primary ms-2">
                Crear primer usuario
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Contar usuarios activos e inactivos
    const rows = document.querySelectorAll('tbody tr');
    let activeCount = 0;
    let inactiveCount = 0;

    rows.forEach(row => {
        const badge = row.querySelector('.badge');
        if (badge && badge.classList.contains('bg-success')) {
            activeCount++;
        } else if (badge && badge.classList.contains('bg-danger')) {
            inactiveCount++;
        }
    });

    // Actualizar contadores
    document.getElementById('usuarios-activos').textContent = activeCount;
    document.getElementById('usuarios-inactivos').textContent = inactiveCount;

    // Inicializar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}